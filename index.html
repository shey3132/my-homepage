<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hebrew Personal Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Added Babel for in-browser JSX transpilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Default to light theme */
      --bg-main: linear-gradient(300deg, #a8e0ff, #c6d9ff, #e3d3ff);
      --bg-sidebar: rgba(255, 255, 255, 0.2);
      --bg-card: rgba(255, 255, 255, 0.5);
      --bg-input: rgba(255, 255, 255, 0.7);
      --text-primary: #1f2937;
      --text-secondary: #4b5563;
      --text-on-accent: #ffffff;
      --accent-primary: #2563eb;
      --accent-primary-hover: #1d4ed8;
      --border-color: rgba(0, 0, 0, 0.1);
      --shadow-color-rgb: 0, 0, 0;
      --shadow-color-light-rgb: 255, 255, 255;
      --shadow-color-dark-rgb: 212, 212, 212;
    }

    body {
      font-family: 'Assistant', Arial, sans-serif;
      overflow: hidden; /* Prevent body scroll, handle scrolling in main content */
      background: var(--bg-main);
      color: var(--text-primary);
      transition: color 0.3s, background 0.3s;
    }
    .animated-bg {
      background: linear-gradient(300deg, #a8e0ff, #c6d9ff, #e3d3ff);
      background-size: 240% 240%;
      animation: gradient-animation 18s ease infinite;
    }
    @keyframes gradient-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.4);
    }
    html {
      scroll-behavior: smooth;
    }
    
    /* Skin System Styles */
    .nav-container-style, .page-header-style, .card-style, .input-style, .button-style {
      transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s, border-radius 0.3s, backdrop-filter 0.3s;
    }

    /* --- Modern Skin (Default) --- */
    [data-skin="modern"] .nav-container-style { backdrop-filter: blur(16px); }
    [data-skin="modern"] .page-header-style { backdrop-filter: blur(12px); border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(var(--shadow-color-rgb), 0.1), 0 4px 6px -4px rgba(var(--shadow-color-rgb), 0.1); }
    [data-skin="modern"] .card-style { backdrop-filter: blur(16px); border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(var(--shadow-color-rgb), 0.1), 0 4px 6px -4px rgba(var(--shadow-color-rgb), 0.1); }
    [data-skin="modern"] .card-style:hover { box-shadow: 0 20px 25px -5px rgba(var(--shadow-color-rgb), 0.1), 0 8px 10px -6px rgba(var(--shadow-color-rgb), 0.1); }
    [data-skin="modern"] .input-style { border-radius: 0.75rem; box-shadow: 0 1px 2px 0 rgba(var(--shadow-color-rgb), 0.05); }
    [data-skin="modern"] .button-style { border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(var(--shadow-color-rgb), 0.1), 0 2px 4px -2px rgba(var(--shadow-color-rgb), 0.1); }
    [data-skin="modern"] .button-style:hover { box-shadow: 0 10px 15px -3px rgba(var(--shadow-color-rgb), 0.1), 0 4px 6px -4px rgba(var(--shadow-color-rgb), 0.1); }

    /* --- Minimalist Skin --- */
    [data-skin="minimalist"] .nav-container-style,
    [data-skin="minimalist"] .page-header-style,
    [data-skin="minimalist"] .card-style { backdrop-filter: none; border-radius: 4px; box-shadow: none; border-width: 2px; }
    [data-skin="minimalist"] .card-style:hover { border-color: var(--accent-primary); transform: none; }
    [data-skin="minimalist"] .input-style { border-radius: 4px; box-shadow: none; border-width: 2px; }
    [data-skin="minimalist"] .input-style:focus { border-color: var(--accent-primary); }
    [data-skin="minimalist"] .button-style { border-radius: 4px; box-shadow: none; border: 2px solid transparent; }
    [data-skin="minimalist"] .button-style:hover { transform: translateY(-2px); }

    /* --- Neumorphic Skin --- */
    [data-skin="neumorphic"] body { background: var(--bg-card) !important; animation: none !important; }
    [data-skin="neumorphic"] .nav-container-style,
    [data-skin="neumorphic"] .page-header-style,
    [data-skin="neumorphic"] .card-style { backdrop-filter: none; border-radius: 1rem; border: 1px solid transparent; background-color: var(--bg-card); }
    [data-skin="neumorphic"] .nav-container-style { background-color: transparent; }
    
    [data-skin="neumorphic"] .page-header-style,
    [data-skin="neumorphic"] .card-style,
    [data-skin="neumorphic"] .button-style {
      box-shadow: 5px 5px 10px rgba(var(--shadow-color-dark-rgb), 0.5), -5px -5px 10px rgba(var(--shadow-color-light-rgb), 0.5);
    }
    [data-skin="neumorphic"] .card-style:hover { transform: none; box-shadow: 7px 7px 14px rgba(var(--shadow-color-dark-rgb), 0.5), -7px -7px 14px rgba(var(--shadow-color-light-rgb), 0.5); }
    [data-skin="neumorphic"] .input-style {
      border-radius: 0.75rem;
      border: 1px solid transparent;
      box-shadow: inset 3px 3px 6px rgba(var(--shadow-color-dark-rgb), 0.5), inset -3px -3px 6px rgba(var(--shadow-color-light-rgb), 0.5);
    }
    [data-skin="neumorphic"] .button-style { border-radius: 0.75rem; }
    [data-skin="neumorphic"] .button-style:hover { transform: translateY(-2px); }
    [data-skin="neumorphic"] .button-style:active {
      box-shadow: inset 3px 3px 6px rgba(var(--shadow-color-dark-rgb), 0.5), inset -3px -3px 6px rgba(var(--shadow-color-light-rgb), 0.5);
      transform: translateY(1px);
    }
    
    .dragging-placeholder {
      border: 2px dashed var(--accent-primary);
      background-color: rgba(var(--accent-primary-rgb), 0.1);
    }
    .dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }

  </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "@google/genai": "https://esm.run/@google/genai"
  }
}
</script>
</head>
<body class="text-gray-800">
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
    import ReactDOM from 'react-dom/client';
    import { GoogleGenAI } from "@google/genai";

    // Formerly types.ts
    const Tab = {
      Home: 'home',
      Tools: 'tools',
      Personal: 'personal',
      History: 'history',
      Design: 'design',
      Map: 'map',
      News: 'news',
      Music: 'music',
    };

    // Formerly constants.ts
    const DEFAULT_SHORTCUTS = [
      { id: 'default-1', title: 'Kore - ×—×“×©×•×ª', url: 'https://www.kore.co.il/' },
      { id: 'default-2', title: 'Amazon', url: 'https://www.amazon.com' },
      { id: 'default-3', title: 'eBay', url: 'https://www.ebay.com' },
      { id: 'default-4', title: 'Zap', url: 'https://www.zap.co.il/' },
      { id: 'default-5', title: '×¦\'××˜ GPT', url: 'https://chat.openai.com' },
      { id: 'default-6', title: 'Gmail', url: 'https://mail.google.com' },
      { id: 'default-7', title: 'Outlook', url: 'https://outlook.live.com' },
      { id: 'default-8', title: 'Google Drive', url: 'https://drive.google.com' },
      { id: 'default-9', title: 'Dropbox', url: 'https://www.dropbox.com' },
      { id: 'default-10', title: 'YouTube', url: 'https://www.youtube.com' },
      { id: 'default-11', title: '××–×’ ××•×•×™×¨ (IMS)', url: 'https://www.ims.gov.il/' },
    ];
    const PRESET_BACKGROUNDS = [
      'linear-gradient(135deg,#b6f0e1,#c6d9ff)', // Default
      'linear-gradient(120deg,#89f7fe,#66a6ff)',
      'linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)', // Lavender
      'linear-gradient(120deg,#fdfbfb,#ebedee)', // Light Gray
      'linear-gradient(to right, #43e97b 0%, #38f9d7 100%)', // Green
      'linear-gradient(to top, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)', // Pink
      'https://images.unsplash.com/photo-1503264116251-35a269479413?q=80&w=1920&auto=format&fit=crop', // Neon City
      'https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1920&auto=format&fit=crop', // Mountain Landscape
      'https://images.unsplash.com/photo-1553095066-5014bc7b7f2d?q=80&w=1920&auto=format&fit=crop', // Abstract Smoke
      'https://images.unsplash.com/photo-1487147264018-f937fba0c817?q=80&w=1920&auto=format&fit=crop', // Pastel Sky
      'https://images.unsplash.com/photo-1536514498073-50e69d39c6cf?q=80&w=1920&auto=format&fit=crop', // Aurora Borealis
      'https://images.unsplash.com/photo-1470770841072-f978cf4d019e?q=80&w=1920&auto=format&fit=crop', // Forest Lake
    ];
    const THEMES = {
      light: {
        name: '×‘×”×™×¨',
        colors: {
          '--bg-main': 'linear-gradient(300deg, #a8e0ff, #c6d9ff, #e3d3ff)',
          '--bg-sidebar': 'rgba(255, 255, 255, 0.2)',
          '--bg-card': 'rgba(255, 255, 255, 0.5)',
          '--bg-input': 'rgba(255, 255, 255, 0.7)',
          '--text-primary': '#1f2937',
          '--text-secondary': '#4b5563',
          '--text-on-accent': '#ffffff',
          '--accent-primary': '#2563eb',
          '--accent-primary-hover': '#1d4ed8',
          '--border-color': 'rgba(0, 0, 0, 0.1)',
          '--shadow-color-rgb': '0, 0, 0',
          '--shadow-color-light-rgb': '255, 255, 255',
          '--shadow-color-dark-rgb': '212, 212, 212',
        }
      },
      dark: {
        name: '×›×”×”',
        colors: {
          '--bg-main': '#111827',
          '--bg-sidebar': 'rgba(0, 0, 0, 0.2)',
          '--bg-card': 'rgba(31, 41, 55, 0.7)',
          '--bg-input': 'rgba(55, 65, 81, 0.8)',
          '--text-primary': '#d1d5db',
          '--text-secondary': '#9ca3af',
          '--text-on-accent': '#ffffff',
          '--accent-primary': '#14b8a6',
          '--accent-primary-hover': '#0d9488',
          '--border-color': 'rgba(255, 255, 255, 0.15)',
          '--shadow-color-rgb': '0, 0, 0',
          '--shadow-color-light-rgb': '55, 65, 81',
          '--shadow-color-dark-rgb': '10, 10, 20',
        }
      },
      ocean: {
        name: '××•×§×™×™× ×•×¡',
        colors: {
          '--bg-main': 'linear-gradient(to top, #00c6fb 0%, #005bea 100%)',
          '--bg-sidebar': 'rgba(0, 50, 100, 0.2)',
          '--bg-card': 'rgba(255, 255, 255, 0.6)',
          '--bg-input': 'rgba(255, 255, 255, 0.8)',
          '--text-primary': '#0b2d48',
          '--text-secondary': '#1e6091',
          '--text-on-accent': '#ffffff',
          '--accent-primary': '#0096c7',
          '--accent-primary-hover': '#0077b6',
          '--border-color': 'rgba(255, 255, 255, 0.2)',
          '--shadow-color-rgb': '0, 0, 0',
          '--shadow-color-light-rgb': '255, 255, 255',
          '--shadow-color-dark-rgb': '200, 220, 255',
        }
      },
      sunset: {
          name: '×©×§×™×¢×”',
          colors: {
              '--bg-main': 'linear-gradient(to right, #ff7e5f, #feb47b)',
              '--bg-sidebar': 'rgba(0, 0, 0, 0.1)',
              '--bg-card': 'rgba(255, 255, 255, 0.5)',
              '--bg-input': 'rgba(255, 255, 255, 0.7)',
              '--text-primary': '#4A0404',
              '--text-secondary': '#7A3E3E',
              '--text-on-accent': '#ffffff',
              '--accent-primary': '#D62828',
              '--accent-primary-hover': '#A82020',
              '--border-color': 'rgba(0, 0, 0, 0.1)',
              '--shadow-color-rgb': '0, 0, 0',
              '--shadow-color-light-rgb': '255, 230, 230',
              '--shadow-color-dark-rgb': '222, 180, 180',
          }
      }
    };
    const SKINS = {
      modern: { name: '××•×“×¨× ×™' },
      minimalist: { name: '××™× ×™××œ×™×¡×˜×™' },
      neumorphic: { name: '× ××•××•×¨×¤×™' },
    };
    const LAYOUTS = {
      classic: { name: '×§×œ××¡×™' },
      topbar: { name: '×¡×¨×’×œ ×¢×œ×™×•×Ÿ' },
    };

    // Formerly hooks/useLocalStorage.ts
    function useLocalStorage(key, initialValue) {
      const [storedValue, setStoredValue] = useState(() => {
        if (typeof window === 'undefined') {
          return initialValue;
        }
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch (error) {
          console.warn(`Could not parse localStorage key "${key}". Resetting to initial value.`, error);
          try {
            window.localStorage.removeItem(key);
          } catch (removeError) {
            console.error(`Failed to remove corrupted key "${key}" from localStorage.`, removeError);
          }
          return initialValue;
        }
      });

      const setValue = (value) => {
        try {
          const valueToStore = value instanceof Function ? value(storedValue) : value;
          setStoredValue(valueToStore);
          if (typeof window !== 'undefined') {
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
          }
        } catch (error) {
          console.error(error);
        }
      };
      
      useEffect(() => {
        const handleStorageChange = (e) => {
          if (e.key === key) {
             if (e.newValue === null) {
                setStoredValue(initialValue);
             } else {
                try {
                  setStoredValue(JSON.parse(e.newValue));
                } catch (error) {
                  console.warn(`Error parsing storage change for key "${key}":`, error);
                }
             }
          }
        };

        window.addEventListener('storage', handleStorageChange);

        return () => {
          window.removeEventListener('storage', handleStorageChange);
        };
      }, [key, initialValue]);

      return [storedValue, setValue];
    }
    
    // Formerly components/Shared.tsx
    const HEBREW_QUOTES = [
        { quote: "×× ××™×Ÿ ×× ×™ ×œ×™, ××™ ×œ×™? ×•×›×©×× ×™ ×œ×¢×¦××™, ××” ×× ×™? ×•×× ×œ× ×¢×›×©×™×•, ××™××ª×™?", author: "×”×œ×œ ×”×–×§×Ÿ" },
        { quote: "×›×œ ××“× ×¦×¨×™×š ×©×™×”×™×” ×œ×• ××©×”×•, ×‘×©×‘×™×œ ×©×™×•×›×œ ×œ×ª×ª.", author: "×¨×‘×™ × ×—××Ÿ ××‘×¨×¡×œ×‘" },
        { quote: "×”×¦×œ×—×” ×”×™× ×”×™×›×•×œ×ª ×œ×¢×‘×•×¨ ××›×™×©×œ×•×Ÿ ×œ×›×™×©×œ×•×Ÿ ××‘×œ×™ ×œ××‘×“ ××ª ×”×”×ª×œ×”×‘×•×ª.", author: "×•×™× ×¡×˜×•×Ÿ ×¦'×¨×¦'×™×œ" },
        { quote: "×”×“×¨×š ×”×˜×•×‘×” ×‘×™×•×ª×¨ ×œ×—×–×•×ª ××ª ×”×¢×ª×™×“ ×”×™× ×œ×™×¦×•×¨ ××•×ª×•.", author: "×¤×™×˜×¨ ×“×¨×•×§×¨" },
        { quote: "×“×¢ ×××™×Ÿ ×‘××ª, ×•×œ××Ÿ ××ª×” ×”×•×œ×š, ×•×œ×¤× ×™ ××™ ××ª×” ×¢×ª×™×“ ×œ×™×ª×Ÿ ×“×™×Ÿ ×•×—×©×‘×•×Ÿ.", author: "×¤×¨×§×™ ××‘×•×ª" },
        { quote: "×”×™×•× ×”×•× ×”×™×•× ×”×¨××©×•×Ÿ ×©×œ ×©××¨×™×ª ×—×™×™×š.", author: "×¤×ª×’× ×¢×××™" },
        { quote: "×”××¢×– ×× ×¦×—.", author: "×¤×ª×’×" },
        { quote: "×”××•×©×¨ ××™× ×• ×™×¢×“, ××œ× ×“×¨×š ×—×™×™×.", author: "×¤×ª×’×" },
        { quote: "×”×—×™×™× ×”× ××” ×©×§×•×¨×” ×œ×š ×‘×–××Ÿ ×©××ª×” ×¢×¡×•×§ ×‘×œ×ª×›× ×Ÿ ×ª×•×›× ×™×•×ª ××—×¨×•×ª.", author: "×’'×•×Ÿ ×œ× ×•×Ÿ" },
        { quote: "××œ ×ª×‘×›×” ×›×™ ×–×” × ×’××¨, ×ª×—×™×™×š ×›×™ ×–×” ×§×¨×”.", author: "×“\"×¨ ×¡×•×¡" },
    ];
    const QuoteOfTheDay = () => {
        const [dailyQuote, setDailyQuote] = useState(null);
        useEffect(() => {
            const startOfYear = new Date(new Date().getFullYear(), 0, 1);
            const dayOfYear = Math.floor((Date.now() - startOfYear.getTime()) / (1000 * 60 * 60 * 24));
            const quoteIndex = dayOfYear % HEBREW_QUOTES.length;
            setDailyQuote(HEBREW_QUOTES[quoteIndex]);
        }, []);
        if (!dailyQuote) return null;
        return (
            <div className="hidden lg:block max-w-sm pl-4">
                <blockquote className="italic text-right" style={{color: 'var(--text-primary)'}}>
                    <p>"{dailyQuote.quote}"</p>
                </blockquote>
                <cite className="block mt-1 text-right text-sm" style={{color: 'var(--text-secondary)'}}>â€” {dailyQuote.author}</cite>
            </div>
        );
    };
    const icons = {
      home: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>,
      tools: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>,
      personal: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>,
      history: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>,
      design: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-2 16.08c0-1.45.69-2.73 1.76-3.54.31-.24.5-.6.5-1.01V11c0-.45-.19-.84-.5-1.1C10.69 9.17 10 7.9 10 6.45c0-1.18.31-2.26.84-3.21-.62-.22-1.28-.34-2-.34-5.52 0-10 4.48-10 10 0 5.16 3.92 9.42 8.94 9.95.02.01.04.01.06.01V20c0-.55.45-1 1-1h1.08c.05 0 .1.01.14.02l.06.01c.21.03.42.05.63.05 1.08 0 2.06-.35 2.87-.95C14.16 19.34 13.21 21 12 21c-1.89 0-3.6-.9-4.69-2.33-.29.13-.56.28-.81.45zM20.71 10.5l-2.2-2.2c-.39-.39-1.02-.39-1.41 0L15 10.41l3.59 3.59L20.71 12c.39-.39.39-1.02 0-1.41zM13 12.01L15.99 15l-4.2 4.2c-.39.39-1.02.39-1.41 0s-.39-1.02 0-1.41L13 15.18V12.01z"/></svg>,
      map: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-6.5 18-3.5-7-7-3.5L20.5 3z"/></svg>,
      news: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2 H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/></svg>,
      music: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>,
    };
    const TABS = [
        { id: Tab.Home, label: '×“×£ ×”×‘×™×ª' },
        { id: Tab.Tools, label: '×›×œ×™×' },
        { id: Tab.Personal, label: '××™×©×™' },
        { id: Tab.History, label: '×”×™×¡×˜×•×¨×™×”' },
        { id: Tab.Design, label: '×¢×™×¦×•×‘' },
        { id: Tab.Map, label: '××¤×”' },
        { id: Tab.News, label: '×—×“×©×•×ª' },
        { id: Tab.Music, label: '××•×–×™×§×”' },
    ];
    const Sidebar = ({ activeTab, setActiveTab }) => {
        return (
            <aside 
              className="nav-container-style w-64 p-4 flex flex-col gap-2 shrink-0 h-full"
              style={{backgroundColor: 'var(--bg-sidebar)'}}
            >
                <h1 
                  className="text-2xl font-bold text-center mb-4 font-[Varela Round]"
                  style={{color: 'var(--text-primary)'}}
                >×”×“×©×‘×•×¨×“ ×©×œ×™</h1>
                <nav className="flex flex-col gap-2">
                    {TABS.map(tab => {
                        const Icon = icons[tab.id];
                        const isActive = activeTab === tab.id;
                        return (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex items-center gap-4 py-3 px-4 rounded-xl text-right font-bold transition-all duration-200 ease-in-out transform hover:scale-105 ${isActive ? 'shadow-lg' : 'hover:bg-[rgba(255,255,255,0.2)]'}`}
                                role="tab"
                                aria-selected={isActive}
                                style={{
                                    backgroundColor: isActive ? 'var(--accent-primary)' : 'transparent',
                                    color: isActive ? 'var(--text-on-accent)' : 'var(--text-primary)',
                                }}
                            >
                                <Icon className="w-6 h-6" />
                                <span>{tab.label}</span>
                            </button>
                        )
                    })}
                </nav>
            </aside>
        );
    };
    const TopNavBar = ({ activeTab, setActiveTab }) => {
        return (
            <header
                className="nav-container-style w-full p-2 px-4 flex items-center justify-between shrink-0 shadow-md"
                style={{ backgroundColor: 'var(--bg-sidebar)' }}
            >
                <h1 className="text-xl font-bold font-[Varela Round]" style={{ color: 'var(--text-primary)' }}>
                    ×”×“×©×‘×•×¨×“ ×©×œ×™
                </h1>
                <nav className="flex items-center gap-1">
                    {TABS.map(tab => {
                        const Icon = icons[tab.id];
                        const isActive = activeTab === tab.id;
                        return (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex items-center gap-2 py-2 px-3 rounded-lg font-semibold transition-colors duration-200 relative`}
                                role="tab"
                                aria-selected={isActive}
                                title={tab.label}
                                style={{
                                    backgroundColor: isActive ? 'var(--accent-primary)' : 'transparent',
                                    color: isActive ? 'var(--text-on-accent)' : 'var(--text-primary)',
                                }}
                            >
                                <Icon className="w-5 h-5" />
                                <span className="hidden md:inline">{tab.label}</span>
                            </button>
                        );
                    })}
                </nav>
            </header>
        );
    };
    const WEATHER_REGIONS = {
        '×ª×œ ××‘×™×‘': { lat: 32.0853, lon: 34.7818 },
        '×™×¨×•×©×œ×™×': { lat: 31.7683, lon: 35.2137 },
        '×—×™×¤×”': { lat: 32.7940, lon: 34.9896 },
        '×‘××¨ ×©×‘×¢': { lat: 31.2530, lon: 34.7915 },
        '××™×œ×ª': { lat: 29.5577, lon: 34.9519 },
        '×¦×¤×ª': { lat: 32.9647, lon: 35.4975 },
        '×˜×‘×¨×™×”': { lat: 32.7922, lon: 35.5312 },
    };
    const useWeather = () => {
        const [selectedRegion, setSelectedRegion] = useLocalStorage('dashboard_weather_region_v1', '×ª×œ ××‘×™×‘');
        const [weatherData, setWeatherData] = useLocalStorage('dashboard_weather_data_v1', null);
        const [lastFetch, setLastFetch] = useLocalStorage('dashboard_weather_fetch_v1', 0);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);

        const getWeatherInfo = (code) => {
            if (code === 0) return { icon: 'â˜€ï¸', description: '×©××™×™× ×‘×”×™×¨×™×' };
            if (code >= 1 && code <= 3) return { icon: 'ğŸŒ¤ï¸', description: '××¢×•× ×Ÿ ×—×œ×§×™×ª' };
            if (code === 45 || code === 48) return { icon: 'ğŸŒ«ï¸', description: '×¢×¨×¤×œ' };
            if (code >= 51 && code <= 57) return { icon: 'ğŸŒ§ï¸', description: '×˜×¤×˜×•×£' };
            if (code >= 61 && code <= 67) return { icon: 'ğŸŒ§ï¸', description: '×’×©×' };
            if (code >= 80 && code <= 82) return { icon: 'ğŸŒ¦ï¸', description: '×××˜×¨×™×' };
            if (code >= 95 && code <= 99) return { icon: 'â›ˆï¸', description: '×¡×•×¤×ª ×¨×¢××™×' };
            return { icon: 'ğŸŒ', description: '×œ× ×™×“×•×¢' };
        };
        
        const fetchWeather = useCallback(async (region) => {
            setLoading(true);
            setError(null);

            const regionData = WEATHER_REGIONS[region];
            if (!regionData) {
                setError('××–×•×¨ ×œ× ×—×•×§×™ × ×‘×—×¨.');
                setLoading(false);
                return;
            }
            const { lat: latitude, lon: longitude } = regionData;

            try {
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=5`);
                if (!weatherRes.ok) throw new Error(`×©×’×™××ª ×¨×©×ª ×‘××–×’ ×”××•×•×™×¨: ${weatherRes.status}`);
                const weatherApiData = await weatherRes.json();
                if (!weatherApiData || !weatherApiData.current || !weatherApiData.daily) throw new Error('×ª×’×•×‘×ª API ×©×œ ××–×’ ××•×•×™×¨ ×œ× ×ª×§×™× ×”.');

                const formattedData = {
                    city: region,
                    current: {
                        temperature: Math.round(weatherApiData.current.temperature_2m),
                        ...getWeatherInfo(weatherApiData.current.weather_code)
                    },
                    forecast: weatherApiData.daily.time.slice(1).map((date, index) => ({
                        date: new Date(date).toLocaleDateString('he-IL', { weekday: 'short' }),
                        maxTemp: Math.round(weatherApiData.daily.temperature_2m_max[index + 1]),
                        minTemp: Math.round(weatherApiData.daily.temperature_2m_min[index + 1]),
                        ...getWeatherInfo(weatherApiData.daily.weather_code[index + 1])
                    }))
                };
                setWeatherData(formattedData);
                setLastFetch(Date.now());
            } catch (e) {
                setError(e.message || '×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™ ××–×’ ××•×•×™×¨.');
                console.error(e);
            } finally {
                setLoading(false);
            }
        }, [setWeatherData, setLastFetch]);

        useEffect(() => {
            const now = Date.now();
            if (!weatherData || weatherData.city !== selectedRegion || (now - lastFetch > 30 * 60 * 1000)) {
                fetchWeather(selectedRegion);
            } else {
                setLoading(false);
            }
        }, [fetchWeather, selectedRegion, weatherData, lastFetch]);
        
        const refresh = () => fetchWeather(selectedRegion);

        return { weatherData, loading, error, selectedRegion, setSelectedRegion, refresh };
    };
    const WeatherHeaderWidget = () => {
        const { weatherData, loading, error, selectedRegion, setSelectedRegion, refresh } = useWeather();
        
        return (
            <div className="flex items-center gap-4">
                {loading && <div style={{color: 'var(--text-secondary)'}}>×˜×•×¢×Ÿ ××–×’ ××•×•×™×¨...</div>}
                {error && <div className="text-red-500 text-sm">×©×’×™××ª ××–×’ ××•×•×™×¨</div>}
                {weatherData && !loading && (
                    <div className="flex items-center gap-2">
                        <span className="text-3xl">{weatherData.current.icon}</span>
                        <div className="text-right">
                            <span className="font-bold text-2xl block">{weatherData.current.temperature}Â°</span>
                            <span className="text-sm" style={{color: 'var(--text-secondary)'}}>{weatherData.current.description}</span>
                        </div>
                    </div>
                )}
                <div className="flex items-center gap-2">
                     <select
                        value={selectedRegion}
                        onChange={e => setSelectedRegion(e.target.value)}
                        className="border rounded-lg focus:ring-2 focus:ring-[var(--accent-primary)] p-1.5 text-base cursor-pointer"
                        style={{backgroundColor: 'var(--bg-input)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}
                        aria-label="×‘×—×¨ ××–×•×¨"
                        disabled={loading}
                    >
                        {Object.keys(WEATHER_REGIONS).map(region => (
                            <option key={region} value={region}>{region}</option>
                        ))}
                    </select>
                    <button onClick={refresh} title="×¨×¢× ×Ÿ" className="transition p-1 disabled:opacity-50 disabled:cursor-wait" style={{color: 'var(--text-secondary)'}} disabled={loading}>
                         <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 ${loading ? 'animate-spin' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" /></svg>
                    </button>
                </div>
            </div>
        );
    };
    const PageHeader = () => {
        const [dateTime, setDateTime] = useState(new Date());
        useEffect(() => {
            const timer = setInterval(() => setDateTime(new Date()), 1000);
            return () => clearInterval(timer);
        }, []);
        const getGreeting = () => {
            const h = dateTime.getHours();
            if (h >= 5 && h < 12) return '×‘×•×§×¨ ×˜×•×‘ â˜€ï¸';
            if (h >= 12 && h < 17) return '×¦×”×¨×™×™× ×˜×•×‘×™× ğŸŒ¤ï¸';
            if (h >= 17 && h < 21) return '×¢×¨×‘ ×˜×•×‘ ğŸŒ†';
            return '×œ×™×œ×” ×˜×•×‘ ğŸŒ™';
        };
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return (
            <header className="mb-4" role="banner">
                <div 
                    className="page-header-style p-4 px-6 border flex justify-between items-center flex-wrap gap-4"
                    style={{backgroundColor: 'var(--bg-card)', borderColor: 'var(--border-color)'}}
                >
                    <div className="flex items-center gap-6 flex-wrap">
                         <div className="text-right">
                            <h2 className="font-bold text-2xl mb-1.5" style={{color: 'var(--text-primary)'}}>{getGreeting()}</h2>
                            <p className="text-md" style={{color: 'var(--text-secondary)'}}>
                                {`ğŸ“… ${dateTime.toLocaleDateString('he-IL', dateOptions)} | â° ${dateTime.toLocaleTimeString('he-IL')}`}
                            </p>
                        </div>
                        <WeatherHeaderWidget />
                    </div>
                    <QuoteOfTheDay />
                </div>
            </header>
        );
    };
    const Panel = ({ id, activeTab, children }) => {
        return (
            <section
                role="tabpanel"
                className={`${activeTab === id ? 'block' : 'hidden'}`}
            >
                {children}
            </section>
        );
    };
    const Card = ({ children, className = '', onClick, ...props }) => {
        const baseClasses = "card-style p-4 text-center border transition-all duration-300";
        const clickableClasses = onClick ? "cursor-pointer hover:-translate-y-1" : "";
        return (
            <div 
              className={`${baseClasses} ${clickableClasses} ${className}`} 
              onClick={onClick}
              style={{
                backgroundColor: 'var(--bg-card)', 
                borderColor: 'var(--border-color)',
              }}
              {...props}
            >
                {children}
            </div>
        );
    };
    const MainButton = ({ children, className, style, ...props }) => (
        <button
            className={`button-style py-2.5 px-5 border-none font-bold cursor-pointer transition-all duration-200 disabled:bg-gray-400 disabled:shadow-none flex items-center justify-center gap-2 ${className}`}
            style={{
              backgroundColor: 'var(--accent-primary)',
              color: 'var(--text-on-accent)',
              ...style
            }}
            onMouseOver={e => {if (!props.disabled) e.currentTarget.style.backgroundColor = 'var(--accent-primary-hover)'}}
            onMouseOut={e => {if (!props.disabled) e.currentTarget.style.backgroundColor = 'var(--accent-primary)'}}
            {...props}
        >
            {children}
        </button>
    );
    const Input = ({ className, ...props }) => (
        <input
            className={`input-style w-full p-2.5 border text-base outline-none transition-shadow focus:shadow-md focus:ring-2 focus:ring-[var(--accent-primary)] ${className}`}
            style={{
              backgroundColor: 'var(--bg-input)',
              borderColor: 'var(--border-color)',
              color: 'var(--text-primary)'
            }}
            {...props}
        />
    );

    // Formerly components/OtherPanels.tsx
    const Calculator = () => {
        const [expression, setExpression] = useState('');
        const [result, setResult] = useState('');
        const [history, setHistory] = useLocalStorage('dashboard_calc_history_v1', []);
        
        const calculate = () => {
            if (!expression) { setResult(''); return; }
            if (!/^[0-9+\-*/().%\s]+$/.test(expression)) { setResult('×‘×™×˜×•×™ ×œ× ×—×•×§×™'); return; }
            try {
                const sanitized = expression.replace(/%/g, '/100');
                const val = Function('"use strict"; return (' + sanitized + ')')();
                setResult('×ª×•×¦××”: ' + val);
                const newEntry = `${expression} = ${val}`;
                setHistory(prev => [newEntry, ...prev].slice(0, 50));
            } catch (e) {
                setResult('×©×’×™××” ×‘×—×™×©×•×‘');
            }
        };

        return (
            <>
                <h3 className="text-xl font-bold mb-2 text-right">××—×©×‘×•×Ÿ ××”×™×¨</h3>
                <Card>
                    <Input value={expression} onChange={e => setExpression(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && calculate()} placeholder="×”×§×œ×“ ×‘×™×˜×•×™ (×œ××©×œ 12+5*3)" />
                    <div className="flex gap-2 mt-2">
                        <MainButton onClick={calculate}>×—×©×‘</MainButton>
                        <MainButton onClick={() => { setExpression(''); setResult(''); }} style={{backgroundColor: '#6b7280', color: 'white'}} onMouseOver={e => e.currentTarget.style.backgroundColor = '#4b5563'} onMouseOut={e => e.currentTarget.style.backgroundColor = '#6b7280'}>× ×§×”</MainButton>
                    </div>
                    <div className="mt-2 text-right min-h-[1.5rem]" style={{color: 'var(--text-secondary)'}}>{result}</div>
                    {history.length > 0 && (
                        <div className="mt-4 text-right">
                            <div className="flex justify-between items-center mb-1">
                                <h4 className="text-sm font-bold" style={{color: 'var(--text-primary)'}}>×”×™×¡×˜×•×¨×™×”</h4>
                                <button
                                    onClick={() => {
                                        if (window.confirm('×”×× ×œ× ×§×•×ª ××ª ×”×™×¡×˜×•×¨×™×™×ª ×”×—×™×©×•×‘×™×?')) {
                                            setHistory([]);
                                        }
                                    }}
                                    className="text-xs bg-gray-200 hover:bg-gray-300 text-gray-600 px-2 py-1 rounded"
                                >
                                    × ×§×” ×”×™×¡×˜×•×¨×™×”
                                </button>
                            </div>
                            <ul className="max-h-32 overflow-y-auto border rounded-lg p-2 bg-[rgba(0,0,0,0.02)] space-y-1 text-sm" style={{borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}>
                                {history.map((item, index) => (
                                    <li
                                        key={index}
                                        onClick={() => setExpression(item.split(' = ')[0])}
                                        onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') setExpression(item.split(' = ')[0])}}
                                        className="cursor-pointer hover:bg-[rgba(0,0,0,0.05)] p-1 rounded focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]"
                                        title="×œ×—×¥ ×›×“×™ ×œ×”×©×ª××© ×©×•×‘ ×‘×‘×™×˜×•×™ ×–×”"
                                        role="button"
                                        tabIndex={0}
                                    >
                                        {item}
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </Card>
            </>
        );
    };
    const Timer = () => {
        const [elapsed, setElapsed] = useState(0);
        const [isRunning, setIsRunning] = useState(false);
        const [timerMode, setTimerMode] = useState('stopwatch');
        const [minutes, setMinutes] = useState('');
        const intervalRef = useRef(null);
        const formatHMS = (s) => {
            const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
            return [h, m, sec].map(v => String(v).padStart(2, '0')).join(':');
        };
        useEffect(() => {
            if (isRunning) {
                const startTime = Date.now() - (timerMode === 'stopwatch' ? elapsed * 1000 : 0);
                const targetTime = Date.now() + elapsed * 1000;
                
                intervalRef.current = window.setInterval(() => {
                    if (timerMode === 'stopwatch') {
                        setElapsed(Math.floor((Date.now() - startTime) / 1000));
                    } else {
                        const remaining = Math.max(0, Math.ceil((targetTime - Date.now()) / 1000));
                        setElapsed(remaining);
                        if (remaining <= 0) {
                            setIsRunning(false);
                            alert('×”×˜×™×™××¨ ×”×•×©×œ×!');
                            setElapsed(0);
                        }
                    }
                }, 250);
            }
            return () => {
                if (intervalRef.current) clearInterval(intervalRef.current);
            };
        }, [isRunning, timerMode, elapsed]);
        const handleStart = () => { setTimerMode('stopwatch'); setIsRunning(true); };
        const handlePause = () => setIsRunning(false);
        const handleReset = () => { setIsRunning(false); setElapsed(0); };
        const handleStartCountdown = () => {
            const mins = parseInt(minutes, 10);
            if (isNaN(mins) || mins <= 0) { alert('×”×–×Ÿ ×“×§×•×ª ×œ×˜×™×™××¨'); return; }
            setTimerMode('countdown');
            setElapsed(mins * 60);
            setIsRunning(true);
        };
        return (
            <>
                <h3 className="text-xl font-bold mt-3 mb-2 text-right">×¡×˜×•×¤×¨ / ×˜×™×™××¨</h3>
                <Card>
                    <div className="font-bold text-3xl text-center font-mono tracking-wider">{formatHMS(elapsed)}</div>
                    <div className="flex gap-2 flex-wrap mt-2 justify-center">
                        <MainButton onClick={handleStart}>×”×ª×—×œ</MainButton>
                        <MainButton onClick={handlePause} className="bg-yellow-500 hover:bg-yellow-600 text-white">×”×©×”×”</MainButton>
                        <MainButton onClick={handleReset} className="bg-red-600 hover:bg-red-700 text-white">××¤×¡</MainButton>
                        <Input type="number" min="0" value={minutes} onChange={e => setMinutes(e.target.value)} placeholder="×“×§×•×ª (×˜×™×™××¨)" className="w-32"/>
                        <MainButton onClick={handleStartCountdown} className="bg-teal-600 hover:bg-teal-700 text-white">×”×ª×—×œ ×˜×™×™××¨</MainButton>
                    </div>
                </Card>
            </>
        );
    };
    const ToolsPanel = () => {
        const [textToTranslate, setTextToTranslate] = useState('');
        const [lang, setLang] = useState('he');
        const handleTranslate = () => {
            if(!textToTranslate.trim()) return alert('×”×›× ×¡ ×˜×§×¡×˜');
            const url = `https://translate.google.com/?sl=auto&tl=${encodeURIComponent(lang)}&text=${encodeURIComponent(textToTranslate)}&op=translate`;
            window.open(url, '_blank');
        };
        return (
            <div className="flex flex-col lg:flex-row gap-4">
                <div className="flex-1 min-w-[260px]">
                    <Calculator />
                    <Timer />
                </div>
                <div className="flex-1 min-w-[260px]">
                    <h3 className="text-xl font-bold mb-2 text-right">×ª×¨×’×•× ××”×™×¨</h3>
                    <Card>
                        <textarea value={textToTranslate} onChange={e => setTextToTranslate(e.target.value)} rows={4} placeholder="×”×›× ×¡ ×˜×§×¡×˜ ×œ×ª×¨×’×•×..." className="input-style w-full p-2.5 border text-base outline-none transition-shadow focus:shadow-md focus:ring-2 focus:ring-[var(--accent-primary)]" style={{backgroundColor: 'var(--bg-input)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}></textarea>
                        <div className="flex gap-2 mt-2">
                            <select value={lang} onChange={e => setLang(e.target.value)} className="input-style p-2.5 border text-base" style={{backgroundColor: 'var(--bg-input)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}>
                                <option value="he">×¢×‘×¨×™×ª</option>
                                <option value="en">×× ×’×œ×™×ª</option>
                                <option value="es">×¡×¤×¨×“×™×ª</option>
                                <option value="fr">×¦×¨×¤×ª×™×ª</option>
                            </select>
                            <MainButton onClick={handleTranslate}>×ª×¨×’× (Google)</MainButton>
                        </div>
                    </Card>
                </div>
            </div>
        );
    };
    const EditorToolbar = ({ onCommand }) => {
        const commands = [
            { cmd: 'bold', icon: 'B', title: '×”×“×’×©×”' },
            { cmd: 'italic', icon: 'I', title: '×”×˜×™×”' },
            { cmd: 'underline', icon: 'U', title: '×§×• ×ª×—×ª×•×Ÿ' },
            { cmd: 'insertUnorderedList', icon: 'â€¢', title: '×¨×©×™××ª ×ª×‘×œ×™×˜×™×' },
            { cmd: 'insertOrderedList', icon: '1.', title: '×¨×©×™××” ×××•×¡×¤×¨×ª' },
        ];
        return (
            <div className="flex gap-1 mb-2 p-1 rounded-md" style={{ backgroundColor: 'var(--bg-input)'}}>
                {commands.map(({ cmd, icon, title }) => (
                    <button
                        key={cmd}
                        title={title}
                        onClick={() => onCommand(cmd)}
                        onMouseDown={e => e.preventDefault()}
                        className="w-8 h-8 font-bold rounded-md hover:bg-[rgba(0,0,0,0.1)] transition-colors"
                    >
                        {icon}
                    </button>
                ))}
            </div>
        );
    };
    const Notes = () => {
        const [notes, setNotes] = useLocalStorage('dashboard_notes_v4_html', '');
        const editorRef = useRef(null);
        
        const handleSave = () => {
            if (editorRef.current) {
                setNotes(editorRef.current.innerHTML);
                alert('×¤×ª×§ × ×©××¨');
            }
        };

        const handleCommand = (cmd) => {
            document.execCommand(cmd, false, null);
            editorRef.current?.focus();
        };

        return (
            <>
                <h3 className="text-xl font-bold mb-2 text-right">×¤×ª×§×™× ××™×©×™×™×</h3>
                <Card className="text-right">
                    <EditorToolbar onCommand={handleCommand} />
                    <div
                        ref={editorRef}
                        contentEditable="true"
                        suppressContentEditableWarning={true}
                        className="input-style w-full p-2.5 border text-base outline-none transition-shadow focus:shadow-md focus:ring-2 focus:ring-[var(--accent-primary)] min-h-[160px] text-right"
                        style={{ backgroundColor: 'var(--bg-card)', borderColor: 'var(--border-color)', color: 'var(--text-primary)' }}
                        dangerouslySetInnerHTML={{ __html: notes }}
                    ></div>
                    <div className="flex gap-2 mt-2">
                        <MainButton onClick={handleSave}>×©××•×¨</MainButton>
                        <MainButton onClick={() => { if(window.confirm('×œ××—×•×§?')) { if(editorRef.current) editorRef.current.innerHTML = ''; } }} className="bg-gray-500 hover:bg-gray-600 text-white">× ×§×”</MainButton>
                    </div>
                </Card>
            </>
        );
    };
    const TodoList = () => {
        const [todos, setTodos] = useLocalStorage('dashboard_todo_v3', []);
        const [newTodo, setNewTodo] = useState('');
        const addTodo = () => {
            if(!newTodo.trim()) return;
            setTodos(prev => [...prev, {txt: newTodo.trim(), done: false}]);
            setNewTodo('');
        };
        const toggleTodo = (index) => {
            setTodos(prev => prev.map((todo, i) => i === index ? { ...todo, done: !todo.done } : todo));
        };
        const deleteTodo = (index) => {
            setTodos(prev => prev.filter((_, i) => i !== index));
        };
        return (
            <>
                <h3 className="text-xl font-bold mt-3 mb-2 text-right">×¨×©×™××ª ××©×™××•×ª</h3>
                <Card className="text-right">
                    <div className="flex gap-2 mb-3">
                        <Input value={newTodo} onChange={e => setNewTodo(e.target.value)} onKeyDown={e => e.key === 'Enter' && addTodo()} placeholder="×”×•×¡×£ ××©×™××”..." />
                        <MainButton onClick={addTodo}>×”×•×¡×£</MainButton>
                    </div>
                    <ul className="list-none p-0 m-0 max-h-60 overflow-y-auto">
                        {todos.map((todo, i) => (
                            <li key={i} className="flex gap-3 items-center p-2.5 border-b border-dashed" style={{borderColor: 'var(--border-color)'}}>
                                <input type="checkbox" checked={todo.done} onChange={() => toggleTodo(i)} className="w-5 h-5 accent-[var(--accent-primary)] cursor-pointer" />
                                <span className={`flex-grow ${todo.done ? 'line-through text-[var(--text-secondary)]' : ''}`}>{todo.txt}</span>
                                <button onClick={() => deleteTodo(i)} className="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition-colors">âœ–</button>
                            </li>
                        ))}
                    </ul>
                    {todos.length > 0 && (
                        <div className="flex gap-2 mt-3 pt-3 border-t" style={{borderColor: 'var(--border-color)'}}>
                            <MainButton onClick={() => setTodos(p => p.filter(t => !t.done))} className="bg-gray-600 hover:bg-gray-700 text-white text-sm">× ×§×” ××¡×•×× ×•×ª</MainButton>
                            <MainButton onClick={() => { if(window.confirm('×œ××—×•×§ ×”×›×œ?')) setTodos([]); }} className="bg-red-600 hover:bg-red-700 text-white text-sm">× ×§×” ×”×›×œ</MainButton>
                        </div>
                    )}
                </Card>
            </>
        );
    };
    const AdvancedShortcuts = ({ shortcuts, setShortcuts, groups }) => {
        const deleteShortcut = (id) => {
            setShortcuts(prev => prev.filter(s => s.id !== id));
        };
        
        const updateShortcutGroup = (id, newGroupId) => {
            setShortcuts(prev => prev.map(s => s.id === id ? { ...s, groupId: newGroupId ? parseInt(newGroupId) : null } : s));
        };

        return (
            <>
                <h3 className="text-xl font-bold mb-2 text-right">× ×™×”×•×œ ×§×™×©×•×¨×™×</h3>
                <Card className="text-right">
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                        {shortcuts.map((s) => (
                            <div key={s.id} className="flex justify-between items-center p-2 rounded-lg gap-2" style={{backgroundColor: 'var(--bg-input)'}}>
                                <a href={s.url} target="_blank" rel="noopener noreferrer" className="hover:underline flex-shrink truncate" style={{color: 'var(--accent-primary)'}}>{s.title}</a>
                                <div className="flex gap-2 items-center flex-shrink-0">
                                    <select 
                                        value={s.groupId || ''} 
                                        onChange={(e) => updateShortcutGroup(s.id, e.target.value)}
                                        className="input-style p-1 text-sm rounded-md"
                                        style={{backgroundColor: 'var(--bg-card)', borderColor: 'var(--border-color)'}}
                                    >
                                        <option value="">×œ×œ× ×§×‘×•×¦×”</option>
                                        {groups.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                                    </select>
                                    <button onClick={() => deleteShortcut(s.id)} className="bg-red-500 text-white rounded px-2 py-1 text-sm hover:bg-red-600 transition-colors">××—×§</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </Card>
            </>
        );
    };
    const ShortcutGroupManager = ({ groups, setGroups }) => {
        const [newGroupName, setNewGroupName] = useState('');

        const addGroup = () => {
            if (!newGroupName.trim()) return;
            setGroups(prev => [...prev, { id: Date.now(), name: newGroupName.trim() }]);
            setNewGroupName('');
        };

        const deleteGroup = (id) => {
            if (window.confirm('××—×™×§×ª ×§×‘×•×¦×” ×ª×©××™×¨ ××ª ×”×§×™×©×•×¨×™× ×©×œ×” ×œ×œ× ×©×™×•×š. ×œ×”××©×™×š?')) {
                setGroups(prev => prev.filter(g => g.id !== id));
            }
        };

        const updateGroupName = (id, newName) => {
            setGroups(prev => prev.map(g => g.id === id ? { ...g, name: newName } : g));
        };

        return (
             <>
                <h3 className="text-xl font-bold mt-3 mb-2 text-right">× ×™×”×•×œ ×§×‘×•×¦×•×ª ×§×™×©×•×¨×™×</h3>
                <p className="text-sm mb-2 text-right" style={{color: 'var(--text-secondary)'}}>
                    ×›××Ÿ ×ª×•×›×œ ×œ×™×¦×•×¨ ×•×œ×¢×¨×•×š ×§×‘×•×¦×•×ª ×›×“×™ ×œ××¨×’×Ÿ ××ª ×§×™×¦×•×¨×™ ×”×“×¨×š ×©×œ×š.
                </p>
                <Card className="text-right">
                    <div className="flex gap-2 mb-3">
                        <Input value={newGroupName} onChange={e => setNewGroupName(e.target.value)} onKeyDown={e => e.key === 'Enter' && addGroup()} placeholder="×©× ×§×‘×•×¦×” ×—×“×©×”..." />
                        <MainButton onClick={addGroup}>×”×•×¡×£ ×§×‘×•×¦×”</MainButton>
                    </div>
                    <div className="space-y-2 max-h-60 overflow-y-auto">
                        {groups.map((g) => (
                            <div key={g.id} className="flex justify-between items-center p-2 rounded-lg" style={{backgroundColor: 'var(--bg-input)'}}>
                                <Input 
                                    value={g.name} 
                                    onChange={(e) => updateGroupName(g.id, e.target.value)}
                                    className="p-1 border-none bg-transparent"
                                />
                                <button onClick={() => deleteGroup(g.id)} className="bg-red-500 text-white rounded px-2 py-1 text-sm hover:bg-red-600 transition-colors">××—×§</button>
                            </div>
                        ))}
                    </div>
                </Card>
            </>
        )
    };
    const PersonalPanel = () => {
        const [shortcuts, setShortcuts] = useLocalStorage('dashboard_shortcuts_v4', []);
        const [shortcutGroups, setShortcutGroups] = useLocalStorage('dashboard_shortcut_groups_v1', []);

        return (
            <div className="flex flex-col lg:flex-row gap-4">
                <div className="flex-1 min-w-[260px]">
                    <Notes />
                    <TodoList />
                </div>
                <div className="flex-1 min-w-[260px]">
                    <AdvancedShortcuts shortcuts={shortcuts} setShortcuts={setShortcuts} groups={shortcutGroups} />
                    <ShortcutGroupManager groups={shortcutGroups} setGroups={setShortcutGroups} />
                </div>
            </div>
        );
    };
    const DesignPanel = ({ setFont, setBackground, themeName, setThemeName, skin, setSkin, layout, setLayout }) => {
        const [holidays, setHolidays] = useLocalStorage('dashboard_holidays_v1', []);
        const [newHolidayDate, setNewHolidayDate] = useState('');
        const [newHolidayTitle, setNewHolidayTitle] = useState('');
        const addHoliday = () => {
            if (!newHolidayDate || !newHolidayTitle.trim()) return alert('×‘×—×¨ ×ª××¨×™×š ×•×©×');
            setHolidays(prev => [...prev, { date: newHolidayDate, title: newHolidayTitle.trim() }]);
            setNewHolidayDate('');
            setNewHolidayTitle('');
        };
        const handleBgUpload = (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = event.target?.result;
                setBackground(data);
                alert('×¨×§×¢ ×”×•×—×œ×£');
            };
            reader.readAsDataURL(file);
        };
        const handleRandomBg = () => {
            const randomBg = PRESET_BACKGROUNDS[Math.floor(Math.random() * PRESET_BACKGROUNDS.length)];
            setBackground(randomBg);
        };
        return (
            <div className="flex flex-col lg:flex-row gap-4">
                <div className="flex-1 min-w-[260px]">
                     <h3 className="text-xl font-bold mb-2 text-right">×¤×¨×™×¡×ª ×¢××•×“</h3>
                    <Card>
                        <div className="grid grid-cols-2 gap-3">
                            {Object.entries(LAYOUTS).map(([key, l]) => (
                                <button
                                    key={key}
                                    onClick={() => setLayout(key)}
                                    className={`p-3 text-center rounded-lg transition-all duration-200 border-2 ${layout === key ? 'ring-2 ring-offset-2 ring-offset-[var(--bg-card)] ring-[var(--accent-primary)]' : 'border-transparent hover:border-[var(--border-color)]'}`}
                                    style={{ backgroundColor: 'var(--bg-input)', borderColor: layout === key ? 'var(--accent-primary)' : 'transparent'}}
                                >
                                    <span className="font-bold block" style={{color: 'var(--text-primary)'}}>{l.name}</span>
                                </button>
                            ))}
                        </div>
                    </Card>
                    <h3 className="text-xl font-bold mt-3 mb-2 text-right">×¡×’× ×•×Ÿ ×¢×™×¦×•×‘</h3>
                    <Card>
                        <div className="grid grid-cols-3 gap-3">
                            {Object.entries(SKINS).map(([key, s]) => (
                                <button
                                    key={key}
                                    onClick={() => setSkin(key)}
                                    className={`p-3 text-center rounded-lg transition-all duration-200 border-2 ${skin === key ? 'ring-2 ring-offset-2 ring-offset-[var(--bg-card)] ring-[var(--accent-primary)]' : 'border-transparent hover:border-[var(--border-color)]'}`}
                                    style={{ backgroundColor: 'var(--bg-input)', borderColor: skin === key ? 'var(--accent-primary)' : 'transparent'}}
                                >
                                    <span className="font-bold block" style={{color: 'var(--text-primary)'}}>{s.name}</span>
                                </button>
                            ))}
                        </div>
                    </Card>
                    <h3 className="text-xl font-bold mt-3 mb-2 text-right">×¢×¨×›×•×ª × ×•×©×</h3>
                    <Card>
                        <div className="grid grid-cols-2 gap-3">
                            {Object.entries(THEMES).map(([key, theme]) => (
                                <button
                                    key={key}
                                    onClick={() => setThemeName(key)}
                                    className={`p-3 rounded-lg text-right transition-all duration-200 border-2 ${themeName === key ? 'ring-2 ring-offset-2 ring-offset-[var(--bg-card)] ring-[var(--accent-primary)]' : 'border-transparent hover:border-[var(--border-color)]'}`}
                                    style={{ backgroundColor: 'var(--bg-card)', borderColor: themeName === key ? 'var(--accent-primary)' : 'transparent'}}
                                >
                                    <span className="font-bold block mb-2" style={{color: 'var(--text-primary)'}}>{theme.name}</span>
                                    <div className="flex gap-1.5 h-6">
                                        <div className="w-1/4 rounded" style={{ background: theme.colors['--bg-main'].startsWith('linear') ? theme.colors['--bg-main'] : theme.colors['--bg-main'] }}></div>
                                        <div className="w-1/4 rounded" style={{ backgroundColor: theme.colors['--accent-primary'] }}></div>
                                        <div className="w-1/4 rounded" style={{ backgroundColor: theme.colors['--text-primary'] }}></div>
                                        <div className="w-1/4 rounded border" style={{ backgroundColor: theme.colors['--bg-card'].replace(/[\d\.]+\)$/, '1)'), borderColor: theme.colors['--border-color'] }}></div>
                                    </div>
                                </button>
                            ))}
                        </div>
                    </Card>
                    <h3 className="text-xl font-bold mt-3 mb-2 text-right">×©×™× ×•×™ ×¤×•× ×˜</h3>
                    <Card>
                        <select onChange={e => setFont(e.target.value)} className="w-full p-2.5 rounded-xl border text-base" style={{backgroundColor: 'var(--bg-input)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}>
                            <option value="'Assistant', Arial, sans-serif">Assistant (×‘×¨×™×¨×ª ××—×“×œ)</option>
                            <option value="'Varela Round', Arial, sans-serif">Varela Round</option>
                            <option value="'Rubik', sans-serif">Rubik</option>
                            <option value="'Heebo', sans-serif">Heebo</option>
                            <option value="'Frank Ruhl Libre', serif">Frank Ruhl Libre</option>
                            <option value="'Courier New', monospace">Monospace</option>
                        </select>
                    </Card>
                    
                </div>
                <div className="flex-1 min-w-[260px]">
                    <h3 className="text-xl font-bold mb-2 text-right">× ×™×”×•×œ ×¨×§×¢</h3>
                    <Card>
                        <div className="flex gap-2 flex-wrap">
                            <label className="button-style p-2.5 cursor-pointer hover:opacity-80 transition-opacity font-semibold" style={{backgroundColor: 'var(--bg-input)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}>×”×¢×œ×” ×¨×§×¢<input type="file" accept="image/*" className="hidden" onChange={handleBgUpload}/></label>
                            <MainButton onClick={() => setBackground(PRESET_BACKGROUNDS[0])} className="bg-yellow-500 hover:bg-yellow-600 text-white">××¤×¡ ×¨×§×¢</MainButton>
                            <MainButton onClick={handleRandomBg} className="bg-green-600 hover:bg-green-700 text-white">×¨×§×¢ ××§×¨××™</MainButton>
                        </div>
                        <hr className="my-3" style={{borderColor: 'var(--border-color)'}}/>
                        <div className="flex gap-2 flex-wrap">
                            {PRESET_BACKGROUNDS.slice(1).map((bg, i) => (
                               <div key={i} onClick={() => setBackground(bg)} className="w-20 h-14 rounded-lg cursor-pointer border-2 border-white/50 bg-cover bg-center shadow-md transition-transform hover:scale-105" style={{backgroundImage: bg.startsWith('linear') ? bg : `url(${bg})` }}></div>
                            ))}
                        </div>
                    </Card>
                    <h3 className="text-xl font-bold mt-3 mb-2 text-right">×ª××¨×™×›×™× ×—×©×•×‘×™×</h3>
                    <Card className="text-right">
                        <div className="flex gap-2">
                            <Input type="date" value={newHolidayDate} onChange={e => setNewHolidayDate(e.target.value)} />
                            <Input placeholder="×©× ×”××™×¨×•×¢" value={newHolidayTitle} onChange={e => setNewHolidayTitle(e.target.value)} />
                        </div>
                        <MainButton onClick={addHoliday} className="mt-2">×”×•×¡×£</MainButton>
                        <ul className="mt-2 text-right space-y-1">
                            {holidays.map((h, i) => <li key={i}>{`${h.date} â€” ${h.title}`}</li>)}
                        </ul>
                    </Card>
                </div>
            </div>
        );
    };
    const MapPanel = () => {
        const [mapQuery, setMapQuery] = useState('Tel Aviv, Israel');
        const [iframeSrc, setIframeSrc] = useState('https://www.google.com/maps?q=Tel+Aviv,Israel&output=embed');
        const handleMapSearch = () => {
            setIframeSrc(`https://www.google.com/maps?q=${encodeURIComponent(mapQuery)}&output=embed`);
        };
        return (
            <Card>
                <div className="flex justify-center gap-2 mb-2.5">
                    <Input value={mapQuery} onChange={e => setMapQuery(e.target.value)} placeholder="×—×¤×© ××™×§×•× ×‘××¤×”..." className="max-w-xl"/>
                    <MainButton onClick={handleMapSearch}>×—×¤×© ×‘××¤×”</MainButton>
                </div>
                <div className="w-full h-[520px] rounded-lg overflow-hidden border shadow-inner" style={{borderColor: 'var(--border-color)'}}>
                    <iframe src={iframeSrc} className="w-full h-full border-0" allowFullScreen loading="lazy"></iframe>
                </div>
            </Card>
        );
    };
    const IFrameCard = ({title, siteUrl, iframeId}) => {
        const refreshIframe = () => {
            const iframe = document.getElementById(iframeId);
            if (iframe) iframe.src = iframe.src;
        };
        return (
            <div className="card-style overflow-hidden border" style={{backgroundColor: 'var(--bg-card)', borderColor: 'var(--border-color)'}}>
                <header className="flex justify-between items-center p-2.5 px-3.5" style={{backgroundColor: 'var(--accent-primary)', color: 'var(--text-on-accent)'}}>
                    <h3 className="m-0 text-lg">{title}</h3>
                    <div className="flex gap-1.5">
                        <button onClick={refreshIframe} className="border-none px-2.5 py-1.5 rounded-lg font-bold cursor-pointer hover:opacity-80" style={{backgroundColor: 'var(--text-on-accent)', color: 'var(--accent-primary)'}}>×¨×¢× ×Ÿ</button>
                        <a href={siteUrl} target="_blank" rel="noopener noreferrer" className="border-none px-2.5 py-1.5 rounded-lg font-bold no-underline" style={{backgroundColor: 'var(--text-on-accent)', color: 'var(--accent-primary)'}}>×¤×ª×—</a>
                    </div>
                </header>
                <iframe id={iframeId} src={siteUrl} className="w-full h-[720px] border-0" loading="lazy" referrerPolicy="no-referrer"></iframe>
            </div>
        );
    };
    const NewsPanel = () => (
        <div className="grid grid-cols-[repeat(auto-fit,minmax(360px,1fr))] gap-4">
            <IFrameCard title="×”×’×™×–×¨×”" siteUrl="https://hagizra.news/" iframeId="news-hagizra" />
            <IFrameCard title="××'×¡ ××•× ×œ×™×™×Ÿ" siteUrl="https://www.emess.co.il/online?native" iframeId="news-emess" />
            <IFrameCard title="Kore M+" siteUrl="https://www.kore.co.il/mplus" iframeId="news-kore" />
        </div>
    );
    const MusicPanel = () => (
        <div className="grid grid-cols-[repeat(auto-fit,minmax(360px,1fr))] gap-4">
            <IFrameCard title="KCM.fm" siteUrl="https://kcm.fm/" iframeId="music-kcm" />
            <IFrameCard title="KCM.fm Live" siteUrl="https://kcm.fm/Live/" iframeId="music-kcm-live" />
            <IFrameCard title="Kol-Play" siteUrl="https://kol-play.co.il/" iframeId="music-kolplay" />
            <IFrameCard title="HNGN" siteUrl="https://www.hngn.co.il/" iframeId="music-hngn" />
            <IFrameCard title="Toker.fm" siteUrl="https://www.toker.fm/" iframeId="music-toker" />
        </div>
    );
    const HistoryPanel = () => {
        const [searchHistory, setSearchHistory] = useLocalStorage('dashboard_search_history_v1', []);
        const handleSearch = (query) => {
            window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        };
        const deleteHistoryItem = (itemToDelete) => {
            setSearchHistory(prev => prev.filter(item => item !== itemToDelete));
        };
        const clearAllHistory = () => {
            if (window.confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×™×¡×˜×•×¨×™×™×ª ×”×—×™×¤×•×©×™×?')) {
                setSearchHistory([]);
            }
        };
        return (
            <div className="max-w-4xl mx-auto">
                <h3 className="text-2xl font-bold mb-3 text-center">×”×™×¡×˜×•×¨×™×™×ª ×—×™×¤×•×©×™×</h3>
                <Card className="text-right p-6">
                    {searchHistory.length > 0 ? (
                        <>
                            <div className="flex justify-end mb-4">
                                <MainButton onClick={clearAllHistory} className="bg-red-600 hover:bg-red-700 text-white">
                                    × ×§×” ××ª ×›×œ ×”×”×™×¡×˜×•×¨×™×”
                                </MainButton>
                            </div>
                            <ul className="space-y-2 list-none p-0 m-0">
                                {searchHistory.map((item, index) => (
                                    <li 
                                        key={index}
                                        className="flex justify-between items-center p-3 rounded-lg flex-wrap gap-2"
                                        style={{backgroundColor: 'var(--bg-input)'}}
                                    >
                                        <span className="font-semibold flex-grow break-all" style={{color: 'var(--text-primary)'}}>{item}</span>
                                        <div className="flex gap-2 flex-shrink-0">
                                            <MainButton
                                                onClick={() => handleSearch(item)}
                                                className="py-1 px-3 !text-sm"
                                                title={`×—×¤×© ×©×•×‘: "${item}"`}
                                            >
                                                ×—×¤×© ×©×•×‘
                                            </MainButton>
                                            <button
                                                onClick={() => deleteHistoryItem(item)}
                                                className="py-1 px-3 rounded-md border-none bg-red-500 text-white font-bold text-sm cursor-pointer hover:bg-red-600 transition-colors"
                                                title={`××—×§ ××”×”×™×¡×˜×•×¨×™×”: "${item}"`}
                                            >
                                                ××—×§
                                            </button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </>
                    ) : (
                        <p className="text-center py-8" style={{color: 'var(--text-secondary)'}}>×”×™×¡×˜×•×¨×™×™×ª ×”×—×™×¤×•×©×™× ×©×œ×š ×¨×™×§×”.</p>
                    )}
                </Card>
            </div>
        );
    };

    // Formerly components/HomePanel.tsx
    const getDomainFromUrl = (url) => {
        try {
            // Ensure URL has a protocol for the URL constructor
            let fullUrl = url;
            if (!/^https?:\/\//i.test(url)) {
                fullUrl = 'https://' + url;
            }
            return new URL(fullUrl).hostname;
        } catch (e) {
            return url;
        }
    };
    const ShortcutGrid = () => {
        const [shortcuts] = useLocalStorage('dashboard_shortcuts_v4', []);
        const [groups] = useLocalStorage('dashboard_shortcut_groups_v1', []);
        
        const groupedShortcuts = useMemo(() => {
            const groupMap = new Map(groups.map(g => [g.id, { ...g, shortcuts: [] }]));
            const uncategorized = [];

            const allShortcuts = [...DEFAULT_SHORTCUTS.map(s => ({...s, groupId: null})), ...shortcuts];

            allShortcuts.forEach(s => {
                if (s.groupId && groupMap.has(s.groupId)) {
                    groupMap.get(s.groupId).shortcuts.push(s);
                } else {
                    uncategorized.push(s);
                }
            });

            const result = Array.from(groupMap.values()).filter(g => g.shortcuts.length > 0);
            if (uncategorized.length > 0) {
                result.push({ id: 'uncategorized', name: '×§×™×©×•×¨×™× ×›×œ×œ×™×™×', shortcuts: uncategorized });
            }
            return result;
        }, [shortcuts, groups]);

        return (
            <div className="space-y-6">
                {groupedShortcuts.map(group => (
                    <div key={group.id}>
                        <h3 className="text-xl font-bold mb-2 text-right">{group.name}</h3>
                        <div className="grid grid-cols-[repeat(auto-fit,minmax(140px,1fr))] gap-4">
                            {group.shortcuts.map((s, idx) => (
                                <Card key={s.id || `${s.url}-${idx}`} className="user-shortcut" onClick={() => window.location.href = s.url}>
                                    <img
                                        className="w-14 h-14 object-contain mb-2 rounded-xl bg-white p-1.5 shadow-md mx-auto"
                                        src={`https://www.google.com/s2/favicons?sz=64&domain=${encodeURIComponent(getDomainFromUrl(s.url))}`}
                                        alt={s.title}
                                        onError={(e) => { e.currentTarget.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56"></svg>'; }}
                                    />
                                    <a href={s.url} onClick={(e) => e.preventDefault()} className="block font-bold no-underline cursor-pointer break-words" style={{color: 'var(--text-primary)'}}>
                                        {s.title}
                                    </a>
                                </Card>
                            ))}
                        </div>
                    </div>
                ))}
            </div>
        );
    };
    const HebrewCalendar = () => {
        const [viewAnchor, setViewAnchor] = useState(new Date());
        const [events, setEvents] = useLocalStorage('dashboard_events_v1', []);
        const [newEventDate, setNewEventDate] = useState(new Date().toISOString().slice(0, 10));
        const [newEventTime, setNewEventTime] = useState('');
        const [newEventTitle, setNewEventTitle] = useState('');
        const hebrewDateUtils = useMemo(() => {
            let fmtWeekdayHeb, fmtPartsLatn;
            try {
                fmtWeekdayHeb = new Intl.DateTimeFormat('he-u-ca-hebrew', { weekday: 'long' });
                fmtPartsLatn = new Intl.DateTimeFormat('he-u-ca-hebrew-nu-latn', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long' });
            } catch (err) {
                console.error('Hebrew calendar Intl not supported:', err);
                return null;
            }
            const hebrewYearGematria = (n) => {
                const y = n % 1000;
                const hundreds = [[400, '×ª'], [300, '×©'], [200, '×¨'], [100, '×§']];
                const tens = [[90, '×¦'], [80, '×¤'], [70, '×¢'], [60, '×¡'], [50, '× '], [40, '×'], [30, '×œ'], [20, '×›'], [10, '×™']];
                const ones = [[9, '×˜'], [8, '×—'], [7, '×–'], [6, '×•'], [5, '×”'], [4, '×“'], [3, '×’'], [2, '×‘'], [1, '×']];
                let rest = y, out = '';
                for (const [v, c] of hundreds) { while (rest >= v) { out += c; rest -= v; } }
                for (const [v, c] of tens) { while (rest >= v) { out += c; rest -= v; } }
                for (const [v, c] of ones) { while (rest >= v) { out += c; rest -= v; } }
                out = out.replace(/×™×”$/, '×˜"×•').replace(/×™×•$/, '×˜"×–');
                if (out.length >= 2) out = out.slice(0, -1) + '"' + out.slice(-1);
                return '×”\'' + out;
            };
            const hebrewDayGematria = (num) => {
                const ones = ['', '×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜']; const tens = ['', '×™', '×›', '×œ', '×', '× ', '×¡', '×¢', '×¤', '×¦'];
                if (num === 15) return '×˜"×•'; if (num === 16) return '×˜"×–';
                const t = Math.floor(num / 10), o = num % 10; let s = '';
                if (t > 0) s += tens[t]; if (o > 0) s += ones[o];
                if (s.length >= 2) s = s.slice(0, -1) + '"' + s.slice(-1);
                return s || '×';
            };
            const getHebParts = (d) => {
                const parts = Object.fromEntries(fmtPartsLatn.formatToParts(d).map(p => [p.type, p.value]));
                return { day: Number(parts.day), monthName: parts.month, year: Number(parts.year), weekday: parts.weekday };
            };
            const findHebMonthStart = (base) => {
                let d = new Date(base.getFullYear(), base.getMonth(), base.getDate()); let guard = 0;
                while (guard++ < 40) { const p = getHebParts(d); if (p.day === 1) return d; d.setDate(d.getDate() - 1); }
                return new Date(base.getFullYear(), base.getMonth(), base.getDate());
            };
            const buildHebMonthDays = (start) => {
                const arr = []; let d = new Date(start); const m = getHebParts(start).monthName; let guard = 0;
                while (guard++ < 40) { arr.push(new Date(d)); d.setDate(d.getDate() + 1); const p = getHebParts(d); if (p.day === 1 && p.monthName !== m) break; }
                return arr;
            };
            const formatFullHebrew = (d) => {
                const p = getHebParts(d);
                return `${fmtWeekdayHeb.format(d)}, ${hebrewDayGematria(p.day)} ×‘${p.monthName}, ${hebrewYearGematria(p.year)}`;
            };
            const monthLength = (base) => buildHebMonthDays(findHebMonthStart(base)).length;
            const shiftHebMonth = (base, delta) => {
                let d = new Date(base);
                for (let i = 0; i < Math.abs(delta); i++) {
                    if (delta > 0) { const start = findHebMonthStart(d); d = new Date(start); d.setDate(start.getDate() + monthLength(d)); } else {
                        const start = findHebMonthStart(d); const prev = new Date(start); prev.setDate(start.getDate() - 1); d = findHebMonthStart(prev);
                    }
                }
                return d;
            };
            const toISO = (d) => d.toISOString().slice(0, 10);
            return { hebrewYearGematria, hebrewDayGematria, getHebParts, findHebMonthStart, buildHebMonthDays, formatFullHebrew, shiftHebMonth, toISO };
        }, []);
        if (!hebrewDateUtils) return <div>×”×œ×•×— ×”×¢×‘×¨×™ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”.</div>;
        const { hebrewYearGematria, hebrewDayGematria, getHebParts, findHebMonthStart, buildHebMonthDays, formatFullHebrew, shiftHebMonth, toISO } = hebrewDateUtils;
        const start = findHebMonthStart(viewAnchor);
        const days = buildHebMonthDays(start);
        const ps = getHebParts(start);
        const headers = ["×", "×‘", "×’", "×“", "×”", "×•", "×©"];
        const firstWeekday = start.getDay();
        const now = new Date();
        const addEventHandler = () => {
            if (!newEventDate || !newEventTitle.trim()) { alert('× × ×œ××œ× ×ª××¨×™×š ×•×›×•×ª×¨×ª'); return; }
            setEvents(prev => [...prev, { date: newEventDate, title: newEventTitle.trim(), time: newEventTime }]);
            setNewEventTitle('');
        };
        const deleteEventHandler = (date, title) => {
            setEvents(prev => prev.filter(e => !(e.date === date && e.title === title)));
        };
        const clearAllEvents = () => {
            if (window.confirm('×”×× ×œ××—×•×§ ××ª ×›×œ ×”××™×¨×•×¢×™×?')) {
                setEvents([]);
            }
        }
        const startOfMonth = findHebMonthStart(viewAnchor);
        const monthDays = buildHebMonthDays(startOfMonth);
        const monthISO = monthDays.map(d => toISO(d));
        const currentMonthEvents = events
          .filter(e => monthISO.includes(e.date))
          .sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
        return (
            <Card className="text-center">
                <div className="flex items-center justify-center gap-2">
                    <button onClick={() => setViewAnchor(shiftHebMonth(viewAnchor, -1))} className="min-w-[36px] h-9 rounded-lg border cursor-pointer text-xl hover:opacity-80 transition" style={{backgroundColor: 'var(--bg-input)', borderColor: 'var(--border-color)'}}>â€¹</button>
                    <div className="font-bold text-lg">{`${ps.monthName} ${hebrewYearGematria(ps.year)}`}</div>
                    <button onClick={() => setViewAnchor(shiftHebMonth(viewAnchor, 1))} className="min-w-[36px] h-9 rounded-lg border cursor-pointer text-xl hover:opacity-80 transition" style={{backgroundColor: 'var(--bg-input)', borderColor: 'var(--border-color)'}}>â€º</button>
                </div>
                <div className="mt-2 font-bold" aria-live="polite">{`×”×™×•×: ${formatFullHebrew(now)}`}</div>
                <table className="w-full border-collapse mt-2">
                    <thead>
                        <tr>{headers.map(h => <th key={h} className="p-2 border font-bold" style={{borderColor: 'var(--border-color)', backgroundColor: 'rgba(0,0,0,0.05)'}}>{h}</th>)}</tr>
                    </thead>
                    <tbody>
                        {Array.from({ length: Math.ceil((days.length + firstWeekday) / 7) }).map((_, weekIndex) => (
                            <tr key={weekIndex}>
                                {Array.from({ length: 7 }).map((_, dayIndex) => {
                                    const dayOfMonthIndex = weekIndex * 7 + dayIndex - firstWeekday;
                                    if (dayOfMonthIndex < 0 || dayOfMonthIndex >= days.length) {
                                        return <td key={dayIndex} className="p-2 border" style={{borderColor: 'var(--border-color)'}}></td>;
                                    }
                                    const gd = days[dayOfMonthIndex];
                                    const p = getHebParts(gd);
                                    const isToday = toISO(gd) === toISO(now);
                                    const iso = toISO(gd);
                                    const dayEvents = events.filter(e => e.date === iso);
                                    return (
                                        <td key={dayIndex} className="p-2 border cursor-pointer relative hover:bg-[rgba(0,0,0,0.05)] transition" style={{borderColor: 'var(--border-color)'}} onClick={() => setNewEventDate(iso)}>
                                            <span style={isToday ? {backgroundColor: 'var(--accent-primary)', color: 'var(--text-on-accent)'} : {}} className={isToday ? "inline-flex items-center justify-center w-9 h-9 rounded-full shadow-md" : ""}>
                                                {hebrewDayGematria(p.day)}
                                            </span>
                                            {dayEvents.length > 0 && <span className="absolute top-1 right-1 block w-2.5 h-2.5 rounded-full border-2 border-white" style={{backgroundColor: 'var(--accent-primary)'}} title={dayEvents.map(e => e.title).join(', ')}></span>}
                                            <small className="block text-xs mt-1" style={{color: 'var(--text-secondary)'}}>{`${gd.getDate()}.${gd.getMonth() + 1}`}</small>
                                        </td>
                                    );
                                })}
                            </tr>
                        ))}
                    </tbody>
                </table>
                <div className="mt-4 text-right">
                    <div className="flex gap-2 flex-wrap items-center">
                        <Input type="date" value={newEventDate} onChange={e => setNewEventDate(e.target.value)} aria-label="×ª××¨×™×š ××™×¨×•×¢" />
                        <Input type="time" value={newEventTime} onChange={e => setNewEventTime(e.target.value)} aria-label="×©×¢×ª ××™×¨×•×¢" />
                        <Input type="text" value={newEventTitle} onChange={e => setNewEventTitle(e.target.value)} placeholder="×›×•×ª×¨×ª ××™×¨×•×¢" className="min-w-[220px] flex-grow" />
                        <MainButton onClick={addEventHandler}>×”×•×¡×£</MainButton>
                        <MainButton onClick={clearAllEvents} className="bg-red-600 hover:bg-red-700 text-white">××—×§ ×”×›×œ</MainButton>
                    </div>
                    <small style={{color: 'var(--text-secondary)'}}>×˜×™×¤: ×œ×—×¥ ×¢×œ ×™×•× ×‘×œ×•×— ×œ××™×œ×•×™ ××•×˜×•××˜×™ ×©×œ ×”×ª××¨×™×š.</small>
                    <div className="mt-3">
                        <h4 className="font-bold mb-2">××™×¨×•×¢×™× ×‘×—×•×“×© ×”× ×•×›×—×™</h4>
                        <ul className="list-none p-0 m-0 grid gap-2">
                            {currentMonthEvents.map((e, i) => (
                               <li key={i} className="border rounded-lg p-2.5 flex justify-between items-center text-sm" style={{backgroundColor: 'rgba(0,0,0,0.05)', borderColor: 'var(--border-color)'}}>
                                   <div>
                                      <span className="font-bold">{e.title}</span>
                                      <span className="mr-2" style={{color: 'var(--text-secondary)'}}>{new Date(e.date+'T00:00:00').toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' })}{e.time && ` ${e.time}`}</span>
                                   </div>
                                   <button onClick={() => deleteEventHandler(e.date, e.title)} className="bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600">××—×§</button>
                               </li>
                            ))}
                        </ul>
                    </div>
                </div>
            </Card>
        );
    };
    const HomePanel = ({ setActiveTab }) => {
        const [searchTerm, setSearchTerm] = useState('');
        const [searchHistory, setSearchHistory] = useLocalStorage('dashboard_search_history_v1', []);
        const [newShortcutTitle, setNewShortcutTitle] = useState('');
        const [newShortcutUrl, setNewShortcutUrl] = useState('');
        const [newShortcutGroup, setNewShortcutGroup] = useState('');
        const [shortcuts, setShortcuts] = useLocalStorage('dashboard_shortcuts_v4', []);
        const [shortcutGroups] = useLocalStorage('dashboard_shortcut_groups_v1', []);
        const [widgetOrder, setWidgetOrder] = useLocalStorage('dashboard_widget_order_v2', ['shortcuts', 'calendar']);
        
        const draggedItem = useRef(null);
        const draggedOverItem = useRef(null);

        const handleSearch = () => {
            const q = searchTerm.trim();
            if (!q) return;
            if (!searchHistory.includes(q)) {
                setSearchHistory(prev => [q, ...prev.slice(0, 49)]);
            }
            window.location.href = `https://www.google.com/search?q=${encodeURIComponent(q)}`;
        };
        const handleAddShortcut = () => {
            const url = newShortcutUrl.trim();
            if (!url) { alert('×”×–×Ÿ URL'); return; }
            let fullUrl = url;
            if (!/^https?:\/\//i.test(url)) {
                fullUrl = 'https://' + url;
            }
            const title = newShortcutTitle.trim() || getDomainFromUrl(fullUrl);
            const newShortcut = { 
                id: Date.now(), 
                title, 
                url: fullUrl, 
                groupId: newShortcutGroup ? parseInt(newShortcutGroup) : null 
            };
            setShortcuts(prev => [...prev, newShortcut]);
            setNewShortcutTitle('');
            setNewShortcutUrl('');
        };
        const handleExport = () => {
            if(shortcuts.length === 0) return alert('××™×Ÿ ×§×™×¦×•×¨×™× ×œ×™×™×¦×•×');
            const dataStr = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(shortcuts));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "shortcuts.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        const handleDragSort = () => {
            const _widgetOrder = [...widgetOrder];
            const draggedItemContent = _widgetOrder.splice(draggedItem.current, 1)[0];
            _widgetOrder.splice(draggedOverItem.current, 0, draggedItemContent);
            draggedItem.current = null;
            draggedOverItem.current = null;
            setWidgetOrder(_widgetOrder);
        };
        
        const widgets = {
            shortcuts: {
                component: <ShortcutGrid />,
                className: "w-full lg:flex-grow-[2] lg:w-2/3"
            },
            calendar: {
                component: <HebrewCalendar />,
                className: "w-full lg:flex-grow-[1] lg:w-1/3"
            },
        };

        return (
            <>
                <div className="flex justify-center gap-2 mb-4">
                    <div className="flex w-full max-w-3xl">
                        <Input
                            type="text"
                            placeholder="×—×¤×© ×‘×’×•×’×œ..."
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && handleSearch()}
                            className="rounded-l-xl rounded-r-none"
                            list="search-suggestions"
                        />
                        <datalist id="search-suggestions">
                            {searchHistory.map(item => <option key={item} value={item} />)}
                        </datalist>
                        <MainButton onClick={handleSearch} className="rounded-r-xl rounded-l-none">
                            <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                            <span>×—×¤×©</span>
                        </MainButton>
                    </div>
                </div>
                <Card className="mb-4">
                    <div className="flex items-center gap-2 flex-wrap justify-center">
                        <Input value={newShortcutTitle} onChange={e => setNewShortcutTitle(e.target.value)} placeholder="×©× ×”×§×™×¦×•×¨ (××•×¤×¦×™×•× ×œ×™)" className="w-48"/>
                        <Input value={newShortcutUrl} onChange={e => setNewShortcutUrl(e.target.value)} placeholder="×›×ª×•×‘×ª ××™× ×˜×¨× ×˜ (URL)" className="w-72"/>
                        <select 
                            value={newShortcutGroup}
                            onChange={e => setNewShortcutGroup(e.target.value)}
                            className="input-style p-2.5 rounded-xl border"
                            style={{backgroundColor: 'var(--bg-input)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}
                        >
                            <option value="">×‘×—×¨ ×§×‘×•×¦×”</option>
                            {shortcutGroups.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                        </select>
                        <MainButton onClick={handleAddShortcut}>×”×•×¡×£ ×§×™×©×•×¨</MainButton>
                        <MainButton onClick={() => setActiveTab(Tab.Personal)} className="bg-gray-600 hover:bg-gray-700 text-white">× ×”×œ ×§×‘×•×¦×•×ª</MainButton>
                    </div>
                </Card>
                <div className="flex flex-col lg:flex-row gap-4 items-start">
                     {widgetOrder.map((widgetKey, index) => (
                        <div
                            key={widgetKey}
                            className={`${widgets[widgetKey].className} transition-transform duration-300`}
                            draggable
                            onDragStart={() => (draggedItem.current = index)}
                            onDragEnter={() => (draggedOverItem.current = index)}
                            onDragEnd={handleDragSort}
                            onDragOver={e => e.preventDefault()}
                        >
                            {widgets[widgetKey].component}
                        </div>
                    ))}
                </div>
            </>
        );
    };

    const FloatingActionButton = ({ onClick }) => (
        <button
            onClick={onClick}
            className="fixed bottom-6 left-6 z-50 w-16 h-16 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 transform hover:scale-110"
            style={{ backgroundColor: 'var(--accent-primary)', color: 'var(--text-on-accent)' }}
            title="×¢×•×–×¨ AI"
            aria-label="×¤×ª×— ×—×œ×•×Ÿ ×¢×•×–×¨ AI"
        >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 9.26l-2.74-1.1L15 5l-1.26 3.16L11 9.26l2.74 1.1L15 13l1.26-2.64L19 9.26zM15 19l-1.26-3.16L11 14.74l2.74-1.1L15 11l1.26 2.64L19 14.74l-2.74 1.1L15 19zM5 13l-1.26-3.16L1 8.74l2.74-1.1L5 5l1.26 2.64L9 8.74l-2.74 1.1L5 13z"/>
            </svg>
        </button>
    );

    const GeminiChat = ({ isOpen, onClose }) => {
        const [apiKey, setApiKey] = useLocalStorage('gemini_api_key_v1', '');
        const [tempApiKey, setTempApiKey] = useState('');
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState('');
        const messagesEndRef = useRef(null);
    
        const ai = useMemo(() => {
            if (!apiKey) return null;
            try {
                setError('');
                return new GoogleGenAI({ apiKey });
            } catch (e) {
                console.error("Failed to initialize GoogleGenAI:", e);
                setError('××¤×ª×— API ×œ× ×ª×§×™×Ÿ. ×× × ×‘×“×•×§ ××ª ×”××¤×ª×— ×©×”×–× ×ª.');
                setApiKey(''); // Clear bad key
                return null;
            }
        }, [apiKey, setApiKey]);
    
        useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [messages]);
        
        const handleSaveApiKey = () => {
            const keyToSave = tempApiKey.trim();
            if (keyToSave) {
                setApiKey(keyToSave);
                setTempApiKey('');
                setError(''); // Clear previous errors
            } else {
                setError('×× × ×”×–×Ÿ ××¤×ª×— API.');
            }
        };
        
        const handleClearKey = () => {
            if (window.confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×—×œ×™×£ ××ª ××¤×ª×— ×”-API? ×”×©×™×—×” ×”× ×•×›×—×™×ª ×ª×™××—×§.')) {
              setApiKey('');
              setMessages([]);
              setError('');
            }
        }
    
        const handleSend = async () => {
            if (!input.trim() || isLoading || !ai) return;
    
            const userMessage = { role: 'user', text: input };
            setMessages(prev => [...prev, userMessage]);
            const currentInput = input;
            setInput('');
            setIsLoading(true);
            setError('');
    
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: currentInput,
                });
                
                const aiMessage = { role: 'model', text: response.text };
                setMessages(prev => [...prev, aiMessage]);
            } catch (err) {
                console.error("Gemini API Error:", err);
                let errorMessageText = "×©×’×™××”, ×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ×ª×©×•×‘×” ××”×©×¨×ª.";
                if (err.message && (err.message.includes('API key not valid') || err.message.includes('permission') || err.message.includes('API_KEY_INVALID'))) {
                    errorMessageText = '××¤×ª×— ×”-API ××™× ×• ×ª×§×™×Ÿ ××• ×©××™×Ÿ ×œ×• ×”×¨×©××•×ª ××ª××™××•×ª. ×× × ×‘×“×•×§ ××ª ×”××¤×ª×— ×•× ×¡×” ×©×•×‘.';
                    setApiKey(''); // Clear the invalid key to force re-entry
                } else if (err.message) {
                     errorMessageText += ` (${err.message})`
                }
                const errorMessage = { role: 'model', text: errorMessageText, isError: true };
                setMessages(prev => [...prev, errorMessage]);
                setError(errorMessageText);
            } finally {
                setIsLoading(false);
            }
        };
    
        if (!isOpen) return null;
    
        const renderContent = () => {
            if (!ai || !apiKey) {
                return (
                    <div className="flex-1 p-6 flex flex-col justify-center items-center text-center">
                        <h4 className="text-xl font-bold mb-3">×‘×¨×•×›×™× ×”×‘××™× ×œ×¢×•×–×¨ ×”-AI</h4>
                        <p className="mb-4" style={{color: 'var(--text-secondary)'}}>
                            ×›×“×™ ×œ×”×ª×—×™×œ, ×™×© ×œ×”×–×™×Ÿ ××¤×ª×— API ××™×©×™ ×©×œ Google Gemini.
                        </p>
                        <a 
                            href="https://aistudio.google.com/app/apikey" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-[var(--accent-primary)] hover:underline mb-4 font-semibold"
                        >
                            ×œ×—×¥ ×›××Ÿ ×›×“×™ ×œ×”× ×¤×™×§ ××¤×ª×— API
                        </a>
                        <div className="w-full max-w-sm">
                            <Input
                                type="password"
                                value={tempApiKey}
                                onChange={e => setTempApiKey(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleSaveApiKey()}
                                placeholder="×”×“×‘×§ ××ª ××¤×ª×— ×”-API ×›××Ÿ"
                                className="text-center"
                            />
                            <MainButton onClick={handleSaveApiKey} className="mt-2 w-full">
                                ×©××•×¨ ×•×”×ª×—×œ ×©×™×—×”
                            </MainButton>
                             {error && <p className="text-red-600 mt-2 text-sm">{error}</p>}
                        </div>
                    </div>
                );
            }
    
            return (
                <>
                    <main className="flex-1 p-4 overflow-y-auto space-y-4">
                        {messages.length === 0 ? (
                            <div className="text-center p-8" style={{color: 'var(--text-secondary)'}}>
                                <p>×©×œ×•×! ××™×š ×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×”×™×•×?</p>
                            </div>
                        ) : (
                            messages.map((msg, index) => (
                                <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] p-3 rounded-2xl ${msg.role === 'user' ? 'bg-[var(--accent-primary)] text-white rounded-br-none' : (msg.isError ? 'bg-red-100 text-red-800' : 'bg-[var(--bg-input)]')} rounded-bl-none`}>
                                        <p style={{whiteSpace: 'pre-wrap'}}>{msg.text}</p>
                                    </div>
                                </div>
                            ))
                        )}
                        {isLoading && (
                             <div className="flex justify-start">
                                <div className="max-w-[80%] p-3 rounded-2xl bg-[var(--bg-input)] rounded-bl-none">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></div>
                                        <div className="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style={{animationDelay: '0.2s'}}></div>
                                        <div className="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style={{animationDelay: '0.4s'}}></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </main>
                    <footer className="p-4 border-t" style={{ borderColor: 'var(--border-color)' }}>
                        {error && !messages.some(m => m.isError) && <p className="text-red-600 text-sm mb-2 text-center">{error}</p>}
                        <div className="flex gap-2">
                            <Input
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleSend()}
                                placeholder="×©××œ ××•×ª×™ ××©×”×•..."
                                disabled={isLoading || !ai}
                            />
                            <MainButton onClick={handleSend} disabled={isLoading || !ai}>×©×œ×—</MainButton>
                        </div>
                    </footer>
                </>
            );
        };
        
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40" onClick={onClose}>
                <div 
                    className="card-style flex flex-col w-full max-w-lg h-[80vh] m-4 overflow-hidden border"
                    style={{ backgroundColor: 'var(--bg-card)', borderColor: 'var(--border-color)' }}
                    onClick={e => e.stopPropagation()}
                >
                    <header className="p-4 flex justify-between items-center border-b" style={{ borderColor: 'var(--border-color)' }}>
                        <h3 className="text-lg font-bold">×¢×•×–×¨ AI (Gemini)</h3>
                        <div className="flex items-center gap-4">
                           {apiKey && <button onClick={handleClearKey} className="text-xs text-[var(--text-secondary)] hover:text-[var(--accent-primary)] font-semibold">×”×—×œ×£ ××¤×ª×—</button>}
                           <button onClick={onClose} className="text-2xl hover:opacity-70">&times;</button>
                        </div>
                    </header>
                    {renderContent()}
                </div>
            </div>
        );
    };

    // Formerly App.tsx
    const App = () => {
        const [activeTab, setActiveTab] = useState(Tab.Home);
        const [background, setBackground] = useLocalStorage('dashboard_bg_v3', PRESET_BACKGROUNDS[0]);
        const [font, setFont] = useState("'Assistant', Arial, sans-serif");
        const [themeName, setThemeName] = useLocalStorage('dashboard_theme_v1', 'light');
        const [skin, setSkin] = useLocalStorage('dashboard_skin_v1', 'modern');
        const [layout, setLayout] = useLocalStorage('dashboard_layout_v1', 'classic');
        const [isChatOpen, setIsChatOpen] = useState(false);

        // --- Data Migration ---
        useEffect(() => {
            // Migrate notes from v3 (plain text) to v4 (HTML)
            const oldNotes = localStorage.getItem('dashboard_notes_v3');
            const newNotesExist = localStorage.getItem('dashboard_notes_v4_html');
            if (oldNotes && !newNotesExist) {
                const parsedOld = JSON.parse(oldNotes);
                const migrated = `<p>${parsedOld.replace(/\n/g, '</p><p>')}</p>`;
                localStorage.setItem('dashboard_notes_v4_html', JSON.stringify(migrated));
            }

            // Migrate shortcuts from v3 to v4 (with groups)
            const oldShortcuts = localStorage.getItem('dashboard_shortcuts_v3');
            const newShortcutsExist = localStorage.getItem('dashboard_shortcuts_v4');
            if (oldShortcuts && !newShortcutsExist) {
                const parsedOld = JSON.parse(oldShortcuts);
                const defaultGroup = { id: Date.now(), name: '×§×™×©×•×¨×™× ×›×œ×œ×™×™×' };
                localStorage.setItem('dashboard_shortcut_groups_v1', JSON.stringify([defaultGroup]));
                const migrated = parsedOld.map(s => ({ ...s, id: Date.now() + Math.random(), groupId: defaultGroup.id }));
                localStorage.setItem('dashboard_shortcuts_v4', JSON.stringify(migrated));
            }
        }, []);

        useEffect(() => {
            const theme = THEMES[themeName] || THEMES.light;
            Object.entries(theme.colors).forEach(([key, value]) => {
                document.documentElement.style.setProperty(key, value);
            });
        }, [themeName]);

        useEffect(() => {
            document.body.style.fontFamily = font;
        }, [font]);

        useEffect(() => {
            document.body.classList.remove('animated-bg');
            if (!background) {
                document.body.style.background = 'var(--bg-main)';
                if (String(document.body.style.background).includes('gradient')) {
                   document.body.classList.add('animated-bg');
                }
                return;
            }
            if (background.startsWith('linear')) {
                document.body.style.background = background;
                document.body.style.backgroundSize = '240% 240%';
                document.body.style.animation = 'gradient-animation 18s ease infinite';
            } else {
                document.body.style.background = `url(${background})`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
                document.body.style.animation = 'none';
            }
        }, [background]);
        
        const mainContent = (
            <div className="flex-1 flex flex-col p-4 overflow-y-auto h-full">
                <PageHeader />
                <main className="flex-1">
                    <Panel id={Tab.Home} activeTab={activeTab}><HomePanel setActiveTab={setActiveTab} /></Panel>
                    <Panel id={Tab.Tools} activeTab={activeTab}><ToolsPanel /></Panel>
                    <Panel id={Tab.Personal} activeTab={activeTab}><PersonalPanel /></Panel>
                    <Panel id={Tab.History} activeTab={activeTab}><HistoryPanel /></Panel>
                    <Panel id={Tab.Design} activeTab={activeTab}><DesignPanel setFont={setFont} setBackground={setBackground} themeName={themeName} setThemeName={setThemeName} skin={skin} setSkin={setSkin} layout={layout} setLayout={setLayout} /></Panel>
                    <Panel id={Tab.Map} activeTab={activeTab}><MapPanel /></Panel>
                    <Panel id={Tab.News} activeTab={activeTab}><NewsPanel /></Panel>
                    <Panel id={Tab.Music} activeTab={activeTab}><MusicPanel /></Panel>
                </main>
                <footer className="text-center mt-3 font-semibold" style={{color: 'var(--text-secondary)'}}>
                    ×“×©×‘×•×¨×“ ××§×•××™ â€” ×›×œ ×”× ×ª×•× ×™× × ×©××¨×™× ×‘×“×¤×“×¤×Ÿ ×©×œ×š
                </footer>
            </div>
        );

        return (
            <div className={`h-screen w-screen bg-transparent flex ${layout === 'classic' ? 'flex-row' : 'flex-col'}`} data-skin={skin}>
                {layout === 'classic' ? (
                    <>
                        <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                        {mainContent}
                    </>
                ) : (
                    <>
                        <TopNavBar activeTab={activeTab} setActiveTab={setActiveTab} />
                        {mainContent}
                    </>
                )}
                <FloatingActionButton onClick={() => setIsChatOpen(true)} />
                <GeminiChat isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} />
            </div>
        );
    };

    // Formerly index.tsx
    const rootElement = document.getElementById('root');
    if (!rootElement) {
      throw new Error("Could not find root element to mount to");
    }
    const root = ReactDOM.createRoot(rootElement);
    root.render(
      <React.StrictMode>
        <App />
      </React.StrictMode>
    );

  </script>
</body>
</html>
